/*! microserviceanalyticscore 2016-04-02 */
"use strict";!function(a,b){"function"==typeof define&&define.amd?define("stackframe",[],b):"object"==typeof exports?module.exports=b():a.StackFrame=b()}(this,function(){function a(a){return!isNaN(parseFloat(a))&&isFinite(a)}function b(a,b,c,d,e,f){void 0!==a&&this.setFunctionName(a),void 0!==b&&this.setArgs(b),void 0!==c&&this.setFileName(c),void 0!==d&&this.setLineNumber(d),void 0!==e&&this.setColumnNumber(e),void 0!==f&&this.setSource(f)}return b.prototype={getFunctionName:function(){return this.functionName},setFunctionName:function(a){this.functionName=String(a)},getArgs:function(){return this.args},setArgs:function(a){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("Args must be an Array");this.args=a},getFileName:function(){return this.fileName},setFileName:function(a){this.fileName=String(a)},getLineNumber:function(){return this.lineNumber},setLineNumber:function(b){if(!a(b))throw new TypeError("Line Number must be a Number");this.lineNumber=Number(b)},getColumnNumber:function(){return this.columnNumber},setColumnNumber:function(b){if(!a(b))throw new TypeError("Column Number must be a Number");this.columnNumber=Number(b)},getSource:function(){return this.source},setSource:function(a){this.source=String(a)},toString:function(){var b=this.getFunctionName()||"{anonymous}",c="("+(this.getArgs()||[]).join(",")+")",d=this.getFileName()?"@"+this.getFileName():"",e=a(this.getLineNumber())?":"+this.getLineNumber():"",f=a(this.getColumnNumber())?":"+this.getColumnNumber():"";return b+c+d+e+f}},b}),function(a,b){"function"==typeof define&&define.amd?define("error-stack-parser",["stackframe"],b):"object"==typeof exports?module.exports=b(require("stackframe")):a.ErrorStackParser=b(a.StackFrame)}(this,function(a){function b(a,b,c){if("function"==typeof Array.prototype.map)return a.map(b,c);for(var d=new Array(a.length),e=0;e<a.length;e++)d[e]=b.call(c,a[e]);return d}function c(a,b,c){if("function"==typeof Array.prototype.filter)return a.filter(b,c);for(var d=[],e=0;e<a.length;e++)b.call(c,a[e])&&d.push(a[e]);return d}var d=/(^|@)\S+\:\d+/,e=/^\s*at .*(\S+\:\d+|\(native\))/m,f=/^(eval@)?(\[native code\])?$/;return{parse:function(a){if("undefined"!=typeof a.stacktrace||"undefined"!=typeof a["opera#sourceloc"])return this.parseOpera(a);if(a.stack&&a.stack.match(e))return this.parseV8OrIE(a);if(a.stack)return this.parseFFOrSafari(a);throw new Error("Cannot parse given Error object")},extractLocation:function(a){if(-1===a.indexOf(":"))return[a];var b=a.replace(/[\(\)\s]/g,"").split(":"),c=b.pop(),d=b[b.length-1];if(!isNaN(parseFloat(d))&&isFinite(d)){var e=b.pop();return[b.join(":"),e,c]}return[b.join(":"),c,void 0]},parseV8OrIE:function(d){var f=c(d.stack.split("\n"),function(a){return!!a.match(e)},this);return b(f,function(b){b.indexOf("(eval ")>-1&&(b=b.replace(/eval code/g,"eval").replace(/(\(eval at [^\()]*)|(\)\,.*$)/g,""));var c=b.replace(/^\s+/,"").replace(/\(eval code/g,"(").split(/\s+/).slice(1),d=this.extractLocation(c.pop()),e=c.join(" ")||void 0,f="eval"===d[0]?void 0:d[0];return new a(e,void 0,f,d[1],d[2],b)},this)},parseFFOrSafari:function(d){var e=c(d.stack.split("\n"),function(a){return!a.match(f)},this);return b(e,function(b){if(b.indexOf(" > eval")>-1&&(b=b.replace(/ line (\d+)(?: > eval line \d+)* > eval\:\d+\:\d+/g,":$1")),-1===b.indexOf("@")&&-1===b.indexOf(":"))return new a(b);var c=b.split("@"),d=this.extractLocation(c.pop()),e=c.shift()||void 0;return new a(e,void 0,d[0],d[1],d[2],b)},this)},parseOpera:function(a){return!a.stacktrace||a.message.indexOf("\n")>-1&&a.message.split("\n").length>a.stacktrace.split("\n").length?this.parseOpera9(a):a.stack?this.parseOpera11(a):this.parseOpera10(a)},parseOpera9:function(b){for(var c=/Line (\d+).*script (?:in )?(\S+)/i,d=b.message.split("\n"),e=[],f=2,g=d.length;g>f;f+=2){var h=c.exec(d[f]);h&&e.push(new a(void 0,void 0,h[2],h[1],void 0,d[f]))}return e},parseOpera10:function(b){for(var c=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,d=b.stacktrace.split("\n"),e=[],f=0,g=d.length;g>f;f+=2){var h=c.exec(d[f]);h&&e.push(new a(h[3]||void 0,void 0,h[2],h[1],void 0,d[f]))}return e},parseOpera11:function(e){var f=c(e.stack.split("\n"),function(a){return!!a.match(d)&&!a.match(/^Error created at/)},this);return b(f,function(b){var c,d=b.split("@"),e=this.extractLocation(d.pop()),f=d.shift()||"",g=f.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^\)]*\)/g,"")||void 0;f.match(/\(([^\)]*)\)/)&&(c=f.replace(/^[^\(]+\(([^\)]*)\)$/,"$1"));var h=void 0===c||"[arguments not available]"===c?void 0:c.split(",");return new a(g,h,e[0],e[1],e[2],b)},this)}}}),function(a){function b(){var b=a.crypto||a.msCrypto;if(!h&&b&&b.getRandomValues)try{var c=new Uint8Array(16);k=h=function(){return b.getRandomValues(c),c},h()}catch(d){}if(!h){var e=new Array(16);i=h=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),e[b]=a>>>((3&b)<<3)&255;return e},"undefined"!=typeof console&&console.warn&&console.warn("[SECURITY] node-uuid: crypto not usable, falling back to insecure Math.random()")}}function c(){if("function"==typeof require)try{var a=require("crypto").randomBytes;j=h=a&&function(){return a(16)},h()}catch(b){}}function d(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>e&&(b[d+e++]=o[a])});16>e;)b[d+e++]=0;return b}function e(a,b){var c=b||0,d=n;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function f(a,b,c){var d=b&&c||0,f=b||[];a=a||{};var g=null!=a.clockseq?a.clockseq:s,h=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:u+1,j=h-t+(i-u)/1e4;if(0>j&&null==a.clockseq&&(g=g+1&16383),(0>j||h>t)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");t=h,u=i,s=g,h+=122192928e5;var k=(1e4*(268435455&h)+i)%4294967296;f[d++]=k>>>24&255,f[d++]=k>>>16&255,f[d++]=k>>>8&255,f[d++]=255&k;var l=h/4294967296*1e4&268435455;f[d++]=l>>>8&255,f[d++]=255&l,f[d++]=l>>>24&15|16,f[d++]=l>>>16&255,f[d++]=g>>>8|128,f[d++]=255&g;for(var m=a.node||r,n=0;6>n;n++)f[d+n]=m[n];return b?b:e(f)}function g(a,b,c){var d=b&&c||0;"string"==typeof a&&(b="binary"===a?new m(16):null,a=null),a=a||{};var f=a.random||(a.rng||h)();if(f[6]=15&f[6]|64,f[8]=63&f[8]|128,b)for(var g=0;16>g;g++)b[d+g]=f[g];return b||e(f)}var h,i,j,k,l;a?b():c();for(var m="function"==typeof Buffer?Buffer:Array,n=[],o={},p=0;256>p;p++)n[p]=(p+256).toString(16).substr(1),o[n[p]]=p;var q=h(),r=[1|q[0],q[1],q[2],q[3],q[4],q[5]],s=16383&(q[6]<<8|q[7]),t=0,u=0,v=g;v.v1=f,v.v4=g,v.parse=d,v.unparse=e,v.BufferClass=m,v._rng=h,v._mathRNG=i,v._nodeRNG=j,v._whatwgRNG=k,"undefined"!=typeof module&&module.exports?module.exports=v:"function"==typeof define&&define.amd?define(function(){return v}):(l=a.uuid,v.noConflict=function(){return a.uuid=l,v},a.uuid=v)}("undefined"!=typeof window?window:null),function(){function a(){s=setTimeout(b,o)}function b(){if(0===n.length)return void a();s=null;var b={ApplicationVersion:"1.0.0.0",Source:"javascript",Events:n};if(window){var c=window.screen.orientation||window.screen.mozOrientation||window.screen.msOrientation;b.Environment={ScreenWidth:window.screen.width,ScreenHeight:window.screen.height,ScreenColorDepth:window.screen.colorDepth,Orientation:c}}var d=JSON.stringify(b);n=[];var e=new XMLHttpRequest;e.onreadystatechange=function(){e.readyState===XMLHttpRequest.DONE&&null==s&&(401===e.status?(z=!0,console&&console.warn("MicroserviceAnalytics client unauthorised - invalid property ID / key pair")):a())},e.open("POST",p,!0),e.setRequestHeader("af-property-id",k),e.setRequestHeader("af-collection-key",l),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.send(d)}function c(){document.body.addEventListener("click",d,!0),document.body.addEventListener("click",e,!1)}function d(a){var b=a.srcElement,c=b.getAttribute("data-journey-start");c&&C.startNamedJourney(c)}function e(a){if(v){var b=a.srcElement,c=b.getAttribute("data-journey-start"),d=b.getAttribute("data-journey-noend");null===d&&c&&v.Data.JourneyCode===c&&C.endCurrentJourney(c)}}function f(a){C.handleJavaScriptError(a.error)}function g(){if(y)return y;var a=t+uuid.v4();return v&&v.CorrelationIds.push(a),a}function h(){var a=C.getContextualCorrelationId();return a||(a=g()),a}function i(a){return 200!==a}function j(){var a=new Date,b=-a.getTimezoneOffset(),c=b>=0?"+":"-",d=function(a){var b=Math.abs(Math.floor(a));return(10>b?"0":"")+b};return a.getFullYear()+"-"+d(a.getMonth()+1)+"-"+d(a.getDate())+"T"+d(a.getHours())+":"+d(a.getMinutes())+":"+d(a.getSeconds())+"."+d(a.getMilliseconds())+c+d(b/60)+":"+d(b%60)}var k,l,m=this,n=[],o=3e3,p="https://collection.microserviceanalytics.com/v1/event",q="correlation-id",r=!0,s=null,t="",u=!0,v=null,w=!0,x=!1,y=null,z=!1,A=[],B=[],C={endJourneyAfterHttpRequest:!1,journeyCodeOwnedByScope:!1},D=function(){if(window){var a=window.localStorage.getItem("msa-user-id");return a||(a=uuid.v4(),window.localStorage.setItem("msa-user-id",a)),a}},E="msa-user-id",F=function(){if(window){var a=window.sessionStorage.getItem("msa-session-id");return a||(a=uuid.v4(),window.sessionStorage.setItem("msa-session-id",a)),a}},G="msa-session-id";!function(a){XMLHttpRequest.prototype.open=function(){var b=this,c=h(),d=b.onreadystatechange;this.onreadystatechange=function(){b.readyState===XMLHttpRequest.DONE&&i(b.status)&&C.handleHttpError(b.status,b.response,c),d&&d()},a.apply(this,arguments),r&&this.setRequestHeader(q,c);var e=F();e&&this.setRequestHeader(G,e);var f=D();f&&this.setRequestHeader(E,f)}}(XMLHttpRequest.prototype.open),function(a){XMLHttpRequest.prototype.send=function(){a.apply(this,arguments)}}(XMLHttpRequest.prototype.send),C.configure=function(d){k=d.propertyId,l=d.propertyKey,d.uploadIntervalMs&&(o=d.uploadIntervalMs),d.collectionEndpoint&&(p=d.collectionEndpoint),d.correlationIdKey&&(q=d.correlationIdKey),d.correlationEnabled&&(r=d.correlationEnabled),t=d.correlationIdPrefix?d.correlationIdPrefix:k+"-",d.autoStartJourneys&&(u=d.autoStartJourneys),d.httpBlacklist&&(B=d.httpBlacklist),d.httpWhitelist&&(A=d.httpWhitelist),d.userIdProvider&&(D=d.userIdProvider),d.userIdKey&&(E=d.userIdKey),d.sessionIdProvider&&(F=d.sessionIdProvider),d.sessionIdKey&&(G=d.sessionIdKey),u&&c(),window&&window.addEventListener("error",f,!0),d.corePageViewReportingEnabled&&window?(C.pageView(window.location.toString()),b()):a()},C.beginScope=function(){C.scopeCorrelationId=t+uuid.v4()},C.endScope=function(){C.scopeCorrelationId=null},C.startJourney=function(a,b,c){void 0===c&&(c=!0),void 0===b&&(b=!1),x=!1,b&&null===C.scopeCorrelationId&&(C.beginScope(),x=!0),w=c,v={EventType:"journey",EventStartDateTime:j(),EventEndDateTime:null,CorrelationIds:[],Data:{JourneyCode:a,EndedWithError:!1}},C.scopeCorrelationId&&v.CorrelationIds.push(C.scopeCorrelationId)},C.endJourney=function(a){z||(x&&C.endScope(),v&&(v.EventEndDateTime=(new Date).toISOString(),a===!0&&(v.Data.EndedWithError=!0),n.push(v),v=null))},C.pageView=function(a,b){b||(b={}),b.Url=a;var c={EventType:"pageview",EventStartDateTime:j(),EventEndDateTime:null,CorrelationIds:[h()],UserId:D(),SessionId:F(),Data:b};n.push(c)},C.handleJavaScriptError=function(a){if(!z){v&&w&&C.endJourney(!0);for(var b=[],c=ErrorStackParser.parse(a),d=0;d<c.length;d++)b.push({Filename:c[d].fileName,Line:c[d].lineNumber,Column:c[d].columnNumber,Assembly:null,Class:null,Method:null});var e={EventType:"error",EventStartDateTime:j(),EventEndDateTime:null,CorrelationIds:[h()],Data:{StackFrames:b,Message:a.message,ExceptionType:a.name?a.name:"javascript"}};n.push(e)}},C.handleHttpError=function(){v&&w&&C.endJourney(!0)},C.createCorrelationId=g,C.getContextualCorrelationId=function(){return null},m.microserviceAnalytics=C}.call(this);