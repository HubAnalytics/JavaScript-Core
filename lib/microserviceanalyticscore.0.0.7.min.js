/*! microserviceanalyticscore 2016-02-06 */
"use strict";!function(a,b){"function"==typeof define&&define.amd?define("stackframe",[],b):"object"==typeof exports?module.exports=b():a.StackFrame=b()}(this,function(){function a(a){return!isNaN(parseFloat(a))&&isFinite(a)}function b(a,b,c,d,e,f){void 0!==a&&this.setFunctionName(a),void 0!==b&&this.setArgs(b),void 0!==c&&this.setFileName(c),void 0!==d&&this.setLineNumber(d),void 0!==e&&this.setColumnNumber(e),void 0!==f&&this.setSource(f)}return b.prototype={getFunctionName:function(){return this.functionName},setFunctionName:function(a){this.functionName=String(a)},getArgs:function(){return this.args},setArgs:function(a){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("Args must be an Array");this.args=a},getFileName:function(){return this.fileName},setFileName:function(a){this.fileName=String(a)},getLineNumber:function(){return this.lineNumber},setLineNumber:function(b){if(!a(b))throw new TypeError("Line Number must be a Number");this.lineNumber=Number(b)},getColumnNumber:function(){return this.columnNumber},setColumnNumber:function(b){if(!a(b))throw new TypeError("Column Number must be a Number");this.columnNumber=Number(b)},getSource:function(){return this.source},setSource:function(a){this.source=String(a)},toString:function(){var b=this.getFunctionName()||"{anonymous}",c="("+(this.getArgs()||[]).join(",")+")",d=this.getFileName()?"@"+this.getFileName():"",e=a(this.getLineNumber())?":"+this.getLineNumber():"",f=a(this.getColumnNumber())?":"+this.getColumnNumber():"";return b+c+d+e+f}},b}),function(a,b){"function"==typeof define&&define.amd?define("error-stack-parser",["stackframe"],b):"object"==typeof exports?module.exports=b(require("stackframe")):a.ErrorStackParser=b(a.StackFrame)}(this,function(a){function b(a,b,c){if("function"==typeof Array.prototype.map)return a.map(b,c);for(var d=new Array(a.length),e=0;e<a.length;e++)d[e]=b.call(c,a[e]);return d}function c(a,b,c){if("function"==typeof Array.prototype.filter)return a.filter(b,c);for(var d=[],e=0;e<a.length;e++)b.call(c,a[e])&&d.push(a[e]);return d}var d=/(^|@)\S+\:\d+/,e=/^\s*at .*(\S+\:\d+|\(native\))/m,f=/^(eval@)?(\[native code\])?$/;return{parse:function(a){if("undefined"!=typeof a.stacktrace||"undefined"!=typeof a["opera#sourceloc"])return this.parseOpera(a);if(a.stack&&a.stack.match(e))return this.parseV8OrIE(a);if(a.stack)return this.parseFFOrSafari(a);throw new Error("Cannot parse given Error object")},extractLocation:function(a){if(-1===a.indexOf(":"))return[a];var b=a.replace(/[\(\)\s]/g,"").split(":"),c=b.pop(),d=b[b.length-1];if(!isNaN(parseFloat(d))&&isFinite(d)){var e=b.pop();return[b.join(":"),e,c]}return[b.join(":"),c,void 0]},parseV8OrIE:function(d){var f=c(d.stack.split("\n"),function(a){return!!a.match(e)},this);return b(f,function(b){b.indexOf("(eval ")>-1&&(b=b.replace(/eval code/g,"eval").replace(/(\(eval at [^\()]*)|(\)\,.*$)/g,""));var c=b.replace(/^\s+/,"").replace(/\(eval code/g,"(").split(/\s+/).slice(1),d=this.extractLocation(c.pop()),e=c.join(" ")||void 0,f="eval"===d[0]?void 0:d[0];return new a(e,void 0,f,d[1],d[2],b)},this)},parseFFOrSafari:function(d){var e=c(d.stack.split("\n"),function(a){return!a.match(f)},this);return b(e,function(b){if(b.indexOf(" > eval")>-1&&(b=b.replace(/ line (\d+)(?: > eval line \d+)* > eval\:\d+\:\d+/g,":$1")),-1===b.indexOf("@")&&-1===b.indexOf(":"))return new a(b);var c=b.split("@"),d=this.extractLocation(c.pop()),e=c.shift()||void 0;return new a(e,void 0,d[0],d[1],d[2],b)},this)},parseOpera:function(a){return!a.stacktrace||a.message.indexOf("\n")>-1&&a.message.split("\n").length>a.stacktrace.split("\n").length?this.parseOpera9(a):a.stack?this.parseOpera11(a):this.parseOpera10(a)},parseOpera9:function(b){for(var c=/Line (\d+).*script (?:in )?(\S+)/i,d=b.message.split("\n"),e=[],f=2,g=d.length;g>f;f+=2){var h=c.exec(d[f]);h&&e.push(new a(void 0,void 0,h[2],h[1],void 0,d[f]))}return e},parseOpera10:function(b){for(var c=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,d=b.stacktrace.split("\n"),e=[],f=0,g=d.length;g>f;f+=2){var h=c.exec(d[f]);h&&e.push(new a(h[3]||void 0,void 0,h[2],h[1],void 0,d[f]))}return e},parseOpera11:function(e){var f=c(e.stack.split("\n"),function(a){return!!a.match(d)&&!a.match(/^Error created at/)},this);return b(f,function(b){var c,d=b.split("@"),e=this.extractLocation(d.pop()),f=d.shift()||"",g=f.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^\)]*\)/g,"")||void 0;f.match(/\(([^\)]*)\)/)&&(c=f.replace(/^[^\(]+\(([^\)]*)\)$/,"$1"));var h=void 0===c||"[arguments not available]"===c?void 0:c.split(",");return new a(g,h,e[0],e[1],e[2],b)},this)}}}),function(a){function b(){var b=a.crypto||a.msCrypto;if(!h&&b&&b.getRandomValues)try{var c=new Uint8Array(16);k=h=function(){return b.getRandomValues(c),c},h()}catch(d){}if(!h){var e=new Array(16);i=h=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),e[b]=a>>>((3&b)<<3)&255;return e},"undefined"!=typeof console&&console.warn&&console.warn("[SECURITY] node-uuid: crypto not usable, falling back to insecure Math.random()")}}function c(){if("function"==typeof require)try{var a=require("crypto").randomBytes;j=h=a&&function(){return a(16)},h()}catch(b){}}function d(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>e&&(b[d+e++]=o[a])});16>e;)b[d+e++]=0;return b}function e(a,b){var c=b||0,d=n;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function f(a,b,c){var d=b&&c||0,f=b||[];a=a||{};var g=null!=a.clockseq?a.clockseq:s,h=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:u+1,j=h-t+(i-u)/1e4;if(0>j&&null==a.clockseq&&(g=g+1&16383),(0>j||h>t)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");t=h,u=i,s=g,h+=122192928e5;var k=(1e4*(268435455&h)+i)%4294967296;f[d++]=k>>>24&255,f[d++]=k>>>16&255,f[d++]=k>>>8&255,f[d++]=255&k;var l=h/4294967296*1e4&268435455;f[d++]=l>>>8&255,f[d++]=255&l,f[d++]=l>>>24&15|16,f[d++]=l>>>16&255,f[d++]=g>>>8|128,f[d++]=255&g;for(var m=a.node||r,n=0;6>n;n++)f[d+n]=m[n];return b?b:e(f)}function g(a,b,c){var d=b&&c||0;"string"==typeof a&&(b="binary"===a?new m(16):null,a=null),a=a||{};var f=a.random||(a.rng||h)();if(f[6]=15&f[6]|64,f[8]=63&f[8]|128,b)for(var g=0;16>g;g++)b[d+g]=f[g];return b||e(f)}var h,i,j,k,l;a?b():c();for(var m="function"==typeof Buffer?Buffer:Array,n=[],o={},p=0;256>p;p++)n[p]=(p+256).toString(16).substr(1),o[n[p]]=p;var q=h(),r=[1|q[0],q[1],q[2],q[3],q[4],q[5]],s=16383&(q[6]<<8|q[7]),t=0,u=0,v=g;v.v1=f,v.v4=g,v.parse=d,v.unparse=e,v.BufferClass=m,v._rng=h,v._mathRNG=i,v._nodeRNG=j,v._whatwgRNG=k,"undefined"!=typeof module&&module.exports?module.exports=v:"function"==typeof define&&define.amd?define(function(){return v}):(l=a.uuid,v.noConflict=function(){return a.uuid=l,v},a.uuid=v)}("undefined"!=typeof window?window:null),function(){function a(){o=window.setTimeout(b,m)}function b(){if(0===l.length)return void a();o=null;var b=JSON.stringify({ApplicationVersion:"1.0.0.0",Source:"javascript",Events:l});l=[];var c=new XMLHttpRequest;c.onreadystatechange=function(){c.readyState===XMLHttpRequest.DONE&&null==o&&a()},c.open("POST",n,!0),c.setRequestHeader("af-property-id",i),c.setRequestHeader("af-collection-key",j),c.setRequestHeader("Content-Type","application/json;charset=UTF-8"),c.send(b)}function c(){document.body.addEventListener("click",d,!0),document.body.addEventListener("click",e,!1)}function d(a){var b=a.srcElement,c=b.getAttribute("data-journey-start");c&&x.startNamedJourney(c)}function e(a){if(r){var b=a.srcElement,c=b.getAttribute("data-journey-start"),d=b.getAttribute("data-journey-noend");null===d&&c&&r.Data.JourneyCode===c&&x.endCurrentJourney(c)}}function f(){}function g(){if(u)return u;var a=p+uuid.v4();return r&&r.CorrelationIds.push(a),a}function h(a){return 200!==a}var i,j,k=this,l=[],m=3e3,n="https://collection.microserviceanalytics.com/v1/event",o=null,p="",q=!0,r=null,s=!0,t=!1,u=null,v=[],w=[],x={endJourneyAfterHttpRequest:!1,journeyCodeOwnedByScope:!1};!function(a){XMLHttpRequest.prototype.open=function(){var b=this,c=g(),d=b.onreadystatechange;this.onreadystatechange=function(){b.readyState===XMLHttpRequest.DONE&&h(b.status)&&x.handleHttpError(b.status,b.response,c),d&&d()},a.apply(this,arguments),this.setRequestHeader("correlation-id",c)}}(XMLHttpRequest.prototype.open),function(a){XMLHttpRequest.prototype.send=function(){a.apply(this,arguments)}}(XMLHttpRequest.prototype.send),x.configure=function(b){i=b.propertyId,j=b.propertyKey,b.interval&&(m=b.interval),b.collectionEndpoint&&(n=b.collectionEndpoint),p=b.correlationIdPrefix?b.correlationIdPrefix:i+"-",b.autoStartJourneys&&(q=b.autoStartJourneys),b.httpBlacklist&&(w=b.httpBlacklist),b.httpWhitelist&&(v=b.httpWhitelist),q&&c(),window.addEventListener("error",f,!0),window.onerror=f,a()},x.beginScope=function(){x.scopeCorrelationId=p+uuid.v4()},x.endScope=function(){x.scopeCorrelationId=null},x.startJourney=function(a,b,c){void 0===c&&(c=!0),void 0===b&&(b=!1),t=!1,b&&null===x.scopeCorrelationId&&(x.beginScope(),t=!0),s=c,r={EventType:"journey",EventStartDateTime:(new Date).toISOString(),EventEndDateTime:null,CorrelationIds:[],Data:{JourneyCode:a,EndedWithError:!1}},x.scopeCorrelationId&&r.CorrelationIds.push(x.scopeCorrelationId)},x.endJourney=function(a){t&&x.endScope(),r&&(r.EventEndDateTime=(new Date).toISOString(),a===!0&&(r.Data.EndedWithError=!0),l.push(r),r=null)},x.handleJavaScriptError=function(a){r&&s&&x.endJourney(!0);for(var b=[],c=ErrorStackParser.parse(a),d=0;d<c.length;d++)b.push({Filename:c[d].fileName,Line:c[d].lineNumber,Column:c[d].columnNumber,Assembly:null,Class:null,Method:null});var e={EventType:"error",EventStartDateTime:(new Date).toISOString(),EventEndDateTime:null,CorrelationIds:[],Data:{StackFrames:b,Message:a.message,ExceptionType:a.name?a.name:"javascript"}};l.push(e)},x.handleHttpError=function(){r&&s&&x.endJourney(!0)},k.microserviceAnalytics=x}.call(this);